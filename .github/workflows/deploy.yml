name: Deploy Vue 3 to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Build project
      run: npm run build

    - name: Fix CSP issues
      run: |
        # åˆ›å»ºå¹¶è¿è¡Œä¿®å¤è„šæœ¬
        cat > fix-csp.js << 'EOF'
        import fs from 'fs';
        import path from 'path';

        console.log('ðŸ”§ Fixing CSP issues in built files...');

        function fixCSSFiles(dir) {
          const files = [];
          
          function scan(currentPath) {
            const items = fs.readdirSync(currentPath);
            items.forEach(item => {
              const fullPath = path.join(currentPath, item);
              const stat = fs.statSync(fullPath);
              if (stat.isDirectory()) {
                scan(fullPath);
              } else if (path.extname(item) === '.css') {
                files.push(fullPath);
              }
            });
          }
          
          scan(dir);
          return files;
        }

        const cssFiles = fixCSSFiles('./dist');
        let fixedCount = 0;

        cssFiles.forEach(file => {
          let content = fs.readFileSync(file, 'utf8');
          
          // Remove inline fonts
          const fontPatterns = [
            /url\("data:application\/font-woff[^"]+"\)/g,
            /url\("data:application\/font-woff2[^"]+"\)/g,
            /url\("data:application\/x-font-woff[^"]+"\)/g
          ];
          
          fontPatterns.forEach(pattern => {
            const matches = content.match(pattern);
            if (matches) {
              fixedCount += matches.length;
              content = content.replace(pattern, '/* inline-font-removed */');
            }
          });
          
          fs.writeFileSync(file, content, 'utf8');
        });

        console.log(`âœ… Fixed ${fixedCount} inline font references`);
        EOF
        
        node fix-csp.js

    - name: Setup Pages
      uses: actions/configure-pages@v2

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v1
      with:
        path: ./dist

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v1